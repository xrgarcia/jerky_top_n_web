=== SENTRY ERROR ANALYSIS REQUEST ===

Issue: JERKY-RANK-UI-Y
Title: Error: Failed query: 
Status: unresolved
Level: warning
Environment: PRODUCTION

First Seen: 2025-10-29T21:38:30.150000Z
Last Seen: 2025-11-07T19:36:34Z
Event Count: 12
Users Affected: 0

--- ERROR MESSAGE ---
Error: Failed query: 

--- CULPRIT ---
LeaderboardManager.getTopRankers(server.services:LeaderboardManager)

--- STACK TRACE ---
Error: Failed query: 
      SELECT 
        u.id as user_id,
        u.first_name,
        u.last_name,
        u.display_name,
        u.email,
        COALESCE(COUNT(DISTINCT pr.shopify_product_id), 0)::int as unique_products,
        (COALESCE(COUNT(DISTINCT ua.id), 0) 
         + COALESCE(COUNT(DISTINCT act_pv.id), 0) 
         + COALESCE(COUNT(DISTINCT pr.id), 0) 
         + COALESCE(COUNT(DISTINCT act_s.id), 0))::int as engagement_score
      FROM users u
      LEFT JOIN product_rankings pr ON pr.user_id = u.id
      LEFT JOIN user_activities act_pv ON act_pv.user_id = u.id AND act_pv.activity_type = 'page_view'
      LEFT JOIN user_achievements ua ON ua.user_id = u.id
      LEFT JOIN user_activities act_s ON act_s.user_id = u.id AND act_s.activity_type = 'search'
      WHERE u.active = true
      GROUP BY u.id
      HAVING (COALESCE(COUNT(DISTINCT ua.id), 0) 
              + COALESCE(COUNT(DISTINCT act_pv.id), 0) 
              + COALESCE(COUNT(DISTINCT pr.id), 0) 
              + COALESCE(COUNT(DISTINCT act_s.id), 0)) > 0
      ORDER BY engagement_score DESC
      LIMIT 5
    
params: 
  at NeonPreparedQuery.queryWithCache (/home/runner/workspace/node_modules/drizzle-orm/pg-core/session.cjs:?:?)
  at process.processTicksAndRejections (node:internal/process/task_queues:?:?)
  at NeonPreparedQuery.execute (/home/runner/workspace/node_modules/drizzle-orm/neon-serverless/session.cjs:?:?)
  at LeaderboardManager.getTopRankers (/home/runner/workspace/server/services/LeaderboardManager.js:?:?) [in app]
  at HomeStatsService.getTopRankers (/home/runner/workspace/server/services/HomeStatsService.js:?:?) [in app]
  at Promise.all (index 0:?:?)
  at HomeStatsService.getAllHomeStats (/home/runner/workspace/server/services/HomeStatsService.js:?:?) [in app]
  at anonymous (/home/runner/workspace/server/init/gamification.js:?:?) [in app]
  at anonymous (/home/runner/workspace/server/services/CacheWarmer.js:?:?) [in app]
  at Promise.allSettled (index 0:?:?)

--- BREADCRUMBS (Recent Activity) ---
[2025-11-07T19:36:21.290000Z] console (info): âœ… Sentry error monitoring initialized (PRODUCTION @ ee30204d-70b2-4d6c-982d-39b9a79d59bc-00-1se2lk54tlocz.spock.replit.dev)
[2025-11-07T19:36:21.290000Z] console (info): ðŸš€ Starting Jerky Top N Web Application...
[2025-11-07T19:36:21.290000Z] console (info): ðŸ” Checking environment configuration...
[2025-11-07T19:36:21.290000Z] console (info): [Filtered]
[2025-11-07T19:36:21.290000Z] console (info): âœ… Database URL found
[2025-11-07T19:36:21.573000Z] console (info): ðŸ“‚ Database storage connected
[2025-11-07T19:36:21.573000Z] console (info): [Filtered]
[2025-11-07T19:36:21.573000Z] console (info): ðŸª  Shop Domain: jerky-com.myshopify.com
[2025-11-07T19:36:21.573000Z] console (info): ðŸŒ  App Domain: ee30204d-70b2-4d6c-982d-39b9a79d59bc-00-1se2lk54tlocz.spock.replit.dev
[2025-11-07T19:36:21.574000Z] console (info): ðŸ”‘  Using Customer Account API for jerky.com accounts
[2025-11-07T19:36:22.947000Z] console (info): âœ… Email service initialized: no-reply@jerky.com via smtp.gmail.com:587
[2025-11-07T19:36:25.939000Z] console (info): âœ… Rate limiters configured using memory (single-instance)
[2025-11-07T19:36:30.403000Z] console (info): ðŸ’¾ Primary database connection configured (no pooler - read from primary)
[2025-11-07T19:36:31.659000Z] console (info): âœ… Server successfully started!
[2025-11-07T19:36:31.660000Z] console (info): ðŸ¥© Jerky Top N Web server running on http://0.0.0.0:5000
[2025-11-07T19:36:31.660000Z] console (info): Visit the app at: http://localhost:5000
[2025-11-07T19:36:31.660000Z] console (info): {"arguments":[""],"logger":"console"}
[2025-11-07T19:36:31.660000Z] console (info): ðŸ“Š Service Status:
[2025-11-07T19:36:31.660000Z] console (info):    Shopify Integration: âœ… Available
[2025-11-07T19:36:31.660000Z] console (info):    Database: âœ… Connected
[2025-11-07T19:36:31.660000Z] console (info): {"arguments":[""],"logger":"console"}
[2025-11-07T19:36:31.679000Z] console (info): ðŸš€ Initializing scalability features...
[2025-11-07T19:36:31.679000Z] console (info): ðŸš€ Initializing distributed cache service...
[2025-11-07T19:36:31.679000Z] console (info): ðŸ” Redis environment: DEVELOPMENT
[2025-11-07T19:36:31.679000Z] console (info): ðŸ” Using Redis variable: UPSTASH_REDIS_URL
[2025-11-07T19:36:31.680000Z] console (info): ðŸ”Œ Establishing Redis connection pool...
[2025-11-07T19:36:31.694000Z] console (info): [Filtered]
[2025-11-07T19:36:31.707000Z] console (info): ðŸŽ® Initializing gamification system...
[2025-11-07T19:36:31.708000Z] console (info): âš ï¸ recentAchievements: Using in-memory cache (single-instance only)
[2025-11-07T19:36:31.708000Z] console (info): ðŸ” Redis environment: DEVELOPMENT
[2025-11-07T19:36:31.708000Z] console (info): ðŸ” Using Redis variable: UPSTASH_REDIS_URL
[2025-11-07T19:36:31.708000Z] console (info): ðŸ”Œ Establishing Redis connection pool...
[2025-11-07T19:36:31.825000Z] console (info): âœ… Redis connection pool established
[2025-11-07T19:36:31.875000Z] console (info): âœ… Redis connection pool established
[2025-11-07T19:36:31.966000Z] console (info): âœ… Redis ready for commands
[2025-11-07T19:36:32.003000Z] console (info): ðŸ“ Redis PING successful - connection pool active
[2025-11-07T19:36:32.005000Z] console (info): âœ… Classification queue initialized
[2025-11-07T19:36:32.008000Z] console (info): âœ… Gamification routes registered at /api/gamification
[2025-11-07T19:36:32.008000Z] console (info): âœ… Community routes registered at /api/community
[2025-11-07T19:36:32.008000Z] console (info): âœ… Flavor profile communities routes registered at /api/flavor-profile-communities
[2025-11-07T19:36:32.008000Z] console (info): ðŸ·ï¸  WebSocket environment prefix: dev
[2025-11-07T19:36:32.009000Z] console (info): âœ… WebSocket gateway initialized
[2025-11-07T19:36:32.009000Z] console (info): ðŸ’¾ Redis: Using existing connection (connection pool)
[2025-11-07T19:36:32.011000Z] console (info): âœ… Classification worker initialized (concurrency: 5)
[2025-11-07T19:36:32.011000Z] console (info): ðŸ’¾ Redis: Using existing connection (connection pool)
[2025-11-07T19:36:32.011000Z] console (info): âœ… Bulk import queue initialized
[2025-11-07T19:36:32.012000Z] console (info): âœ… BulkImportService initialized with WebSocket gateway and classification queue
[2025-11-07T19:36:32.012000Z] console (info): ðŸ’¾ Redis: Using existing connection (connection pool)
[2025-11-07T19:36:32.012000Z] console (info): âœ… Bulk import worker initialized (concurrency: 15, rate limit: 50 jobs/min)
[2025-11-07T19:36:32.014000Z] console (info): ðŸŽ® Gamification system initialized successfully
[2025-11-07T19:36:32.021000Z] console (info): âœ… Gamification services available for achievements
[2025-11-07T19:36:32.120000Z] console (info): ðŸ“¨ Shopify webhook endpoints registered at /api/webhooks/shopify/*
[2025-11-07T19:36:32.125000Z] console (info): âœ… Tools routes registered at /api/tools
[2025-11-07T19:36:33.482000Z] console (info): âœ… Object storage route registered at /objects/*
[2025-11-07T19:36:34.171000Z] console (info): âœ… Admin routes registered at /api/admin
[2025-11-07T19:36:34.171000Z] console (info): âœ… Catch-all route registered (serves React SPA)
[2025-11-07T19:36:34.173000Z] console (info): ðŸ”¥ CacheWarmer: Starting to warm 3 cache(s)...
[2025-11-07T19:36:34.173000Z] console (info): ðŸš« HomeStatsCache MISS: Data expired or not found
[2025-11-07T19:36:34.174000Z] console (info): ðŸš« LeaderboardCache MISS: all_time:5
[2025-11-07T19:36:34.176000Z] console (info): ðŸš« LeaderboardCache MISS: all_time:5
[2025-11-07T19:36:34.176000Z] console (info): ðŸš« Cache MISS: No cached data
[2025-11-07T19:36:34.177000Z] console (info): ðŸ”„ Fetching fresh products from Shopify API...
[2025-11-07T19:36:34.196000Z] console (info): ðŸ“¨ Registering Shopify webhooks...
[2025-11-07T19:36:34.198000Z] console (info): âœ… Redis ready for commands
[2025-11-07T19:36:34.198000Z] http (info): {"http.method":"GET","url":"https://helium/v2"}
[2025-11-07T19:36:34.200000Z] console (error): âŒ Failed to seed achievement first_rank: Failed query: 
          INSERT INTO achievements (code, name, description, icon, tier, category, collection_type, requirement, has_tiers, points)
          VALUES (
            $1,
            $2,
            $3,
            $4,
            $5,
            $6,
            $7,
            $8::jsonb,
            $9,
            $10
          )
          ON CONFLICT (code) DO UPDATE SET
            name = EXCLUDED.name,
            description = EXCLUDED.description,
            icon = EXCLUDED.icon,
            tier = EXCLUDED.tier,
            category = EXCLUDED.category,
            collection_type = EXCLUDED.collection_type,
            requirement = EXCLUDED.requirement,
            has_tiers = EXCLUDED.has_tiers,
            points = EXCLUDED.points
        
params: first_rank,First Steps,Rank your first product,ðŸŽ¯,bronze,ranking,legacy,{"type":"rank_count","value":1},0,10 Error: Failed query: 
          INSERT INTO achievements (code, name, description, icon, tier, category, collection_type, requirement, has_tiers, points)
          VALUES (
            $1,
            $2,
            $3,
            $4,
            $5,
            $6,
            $7,
            $8::jsonb,
            $9,
            $10
          )
          ON CONFLICT (code) DO UPDATE SET
            name = EXCLUDED.name,
            description = EXCLUDED.description,
            icon = EXCLUDED.icon,
            tier = EXCLUDED.tier,
            category = EXCLUDED.category,
            collection_type = EXCLUDED.collection_type,
            requirement = EXCLUDED.requirement,
            has_tiers = EXCLUDED.has_tiers,
            points = EXCLUDED.points
        
params: first_rank,First Steps,Rank your first product,ðŸŽ¯,bronze,ranking,legacy,{"type":"rank_count","value":1},0,10
[2025-11-07T19:36:34.260000Z] console (error): âŒ Unhandled Rejection at: [object Promise]
[2025-11-07T19:36:34.260000Z] console (error): Reason: TypeError: fetch failed
[2025-11-07T19:36:34.267000Z] console (info): ðŸ“ Redis PING successful - connection pool active
[2025-11-07T19:36:34.267000Z] console (info): âœ… homeStats: Using Redis for distributed caching
[2025-11-07T19:36:34.267000Z] console (info): âœ… leaderboard: Using Redis for distributed caching
[2025-11-07T19:36:34.267000Z] console (info): âœ… leaderboardPosition: Using Redis for distributed caching
[2025-11-07T19:36:34.267000Z] console (info): âœ… achievement: Using Redis for distributed caching
[2025-11-07T19:36:34.268000Z] console (info): âœ… metadata: Using Redis for distributed caching
[2025-11-07T19:36:34.268000Z] console (info): âœ… rankingStats: Using Redis for distributed caching
[2025-11-07T19:36:34.268000Z] console (info): âœ… products: Using Redis for distributed caching
[2025-11-07T19:36:34.268000Z] console (info): âœ… All caches using Redis for distributed caching
[2025-11-07T19:36:34.268000Z] console (info): ðŸ”Œ Setting up Socket.IO Redis adapter with shared connection...
[2025-11-07T19:36:34.364000Z] http (info): {"http.method":"GET","url":"https://helium/v2"}
[2025-11-07T19:36:34.365000Z] console (warning): âš ï¸ CacheWarmer: HomeStatsCache failed to warm (191ms): Failed query: 
      SELECT 
        u.id as user_id,
        u.first_name,
        u.last_name,
        u.display_name,
        u.email,
        COALESCE(COUNT(DISTINCT pr.shopify_product_id), 0)::int as unique_products,
        (COALESCE(COUNT(DISTINCT ua.id), 0) 
         + COALESCE(COUNT(DISTINCT act_pv.id), 0) 
         + COALESCE(COUNT(DISTINCT pr.id), 0) 
         + COALESCE(COUNT(DISTINCT act_s.id), 0))::int as engagement_score
      FROM users u
      LEFT JOIN product_rankings pr ON pr.user_id = u.id
      LEFT JOIN user_activities act_pv ON act_pv.user_id = u.id AND act_pv.activity_type = 'page_view'
      LEFT JOIN user_achievements ua ON ua.user_id = u.id
      LEFT JOIN user_activities act_s ON act_s.user_id = u.id AND act_s.activity_type = 'search'
      WHERE u.active = true
      GROUP BY u.id
      HAVING (COALESCE(COUNT(DISTINCT ua.id), 0) 
              + COALESCE(COUNT(DISTINCT act_pv.id), 0) 
              + COALESCE(COUNT(DISTINCT pr.id), 0) 
              + COALESCE(COUNT(DISTINCT act_s.id), 0)) > 0
      ORDER BY engagement_score DESC
      LIMIT 5
    
params: 

--- TAGS ---
  app_url: undefined
  cache_name: undefined
  duration_ms: undefined
  environment: undefined
  handled: undefined
  level: undefined
  mechanism: undefined
  os: undefined
  operation: undefined
  os.name: undefined
  runtime: undefined
  runtime.name: undefined
  server_name: undefined
  service: undefined

--- CONTEXT ---
No context available

--- REQUEST (if applicable) ---
No request data

--- USER (if available) ---
{
  "id": null,
  "email": null,
  "username": null,
  "ip_address": null,
  "name": null,
  "geo": {
    "country_code": "US",
    "city": "The Dalles",
    "region": "United States"
  },
  "data": null
}

--- SDK INFO ---
Platform: node
SDK: sentry.javascript.node 10.19.0

=== END ANALYSIS REQUEST ===

Please analyze this error and suggest:
1. Root cause
2. Potential fixes
3. Why this error occurred
4. How to prevent it in the future